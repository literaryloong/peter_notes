# 中台实战

作者： 郭忆，网易大数据平台的负责人

### 01 | 前因后果：为什么说数据中台是大数据的下一站？

**数据启蒙：数据仓库**

> 数据仓库是在企业管理和决策中面向主题的、集成的、与时间相关的，不可修改的数据集合。

建模思路：

1. 恩门建模 自顶（数据的来源）向下，从各个业务数据库出发，基于业务间各个实体及期间的关系，构建数据仓库
2. 金博尔建模 是一种自底向上的模型设计方法，从数据分析的需求出发，拆分维度和事实

**技术革命：Hadoop到数据湖**

Pentaho 创始人兼 CTO James Dixon 在纽约 Hadoop World 大会上提出了数据湖的概念，他提到：

> 数据湖（Data Lake）是一个以原始格式存储数据的存储库或系统。

数据中台的核心，是避免数据的重复计算，通过数据服务化，提高数据的共享能力，赋能数据应用。

![img](imgs/数据治理-网易中台课/e5ec6e5bc4e7c64718c0d961b9627b78.jpg)

### 02 | 关键抉择： 到底什么样的企业应该建数据中台？

作者遇到的问题：

1. 指标口径不一致
2. 数据重复建设，需求响应时间长
3. 取数效率低、数据质量差、数据成本线性增长

自助取数：

![img](imgs/数据治理-网易中台课/36cb4c806b39fd38691133df5cbf2d03.jpg)



数据质量的把控：

数据的一致性、完整性、正确性和及时性。出现数据问题，第一时间发现、处理、通知

![img](imgs/数据治理-网易中台课/1a03abc87fb3bd691a03d2a56c974e9c.jpg)

### 03 | 数据中台建设三板斧：方法论、组织和技术

阿里巴巴16年提出 OneData和OneService核心方法论。

OneData数据只加工一次：分主题域管理、命名规范、指标一致、数据模型复用、数据完善；

```shell
dwd__wms__inbound__item__info__di
明细层 主题域 业务过程   内容    分区规则
```

![image-20220328135200742](imgs/数据治理-网易中台课/image-20220328135200742.png)

OneService: 屏蔽异构数据源、数据网关（权限、监控、流控、日志）、逻辑模型、性能和稳定性

网易数据中台架构：

![img](imgs/数据治理-网易中台课/8da01dbcf1f318fcf90d3c26e3f1b602.jpg)



![img](imgs/数据治理-网易中台课/afedf9dca0f4366ff3fad9ef2f44b952.jpg)

### 04 | 元数据中心的关键目标和技术实现方案

结合我的实践经验，我把元数据划为三类：**数据字典、数据血缘和数据特征**。

> 数据字典：表名、描述、产出物、字段及含义、类型
>
> 数据血缘：一个表直接通过哪些表加工而来
>
> 数据特征：存储大小、访问热度、主题域、分层、关联指标



与Ranger集成，实现基于Tag的权限管理方式。

网易元数据管理中心：

![img](imgs/数据治理-网易中台课/d590abca0d8f54d19fa413696dfd97f4.jpg)



元数据中心界面： 如何找数据？

![img](imgs/数据治理-网易中台课/7b0bb4f2555d4610a05b91c86416888c.png)



![img](imgs/数据治理-网易中台课/069ede4c461619307896563cbf681063.jpg)



### 05 | 如何统一管理纷繁杂乱的数据指标？

>  指标: 业务元数据。数据的**统计口径**。
>
> 同名不同径，同径不同名。口径不清晰，口径有错误。命名难理解，计算不易懂。来源不清晰，同部不同径。

规范化指标定义：

1. 面向主题域管理

2. 拆分原子指标和派生指标

   ![img](imgs/数据治理-网易中台课/b411dd7d53b272af1ec4b3c839c8cb01.jpg)

3. 规范化命名

4. 关联的应用和可分析维度

5. 分等级管理

![img](imgs/数据治理-网易中台课/b39e3317ec1c4b52828ce480ab1cfd64.jpg)

![img](imgs/数据治理-网易中台课/5f0e0df7a3ddaedc674d22b0a796fe3c.jpg)



![img](imgs/数据治理-网易中台课/a6b5d401cb6fe286dd26302096488ad7.jpg)



### 06 | 数据模型无法复用，归根结底还是设计问题

ODS层被query命中的次数过多（越底层被查询命中，扫描的数据量越大，查询时间和资源消耗越大）。

如何衡量复用度

+ DWD层完善度

  > 跨层引用率: ODS 层直接被 DWS/ADS/DM 层引用的表，占所有 ODS 层表（仅统计活跃表）比例。

+ DWS/ADS/DM层完善度

  > 汇总数据查询比例：DWS/ADS/DM 层的查询占所有查询的比例。

+ 模型引用系数： 一个模型被读取，直接产生下游的平均数量。 >=3

**如何从烟囱式的小数仓到共享的数据中台**

1. 接管ODS层
2. 划分主题域，规划总线矩阵
3. 构建一致性维度
4. 事实表整合
5. 模型开发
   1. 模型任务依赖，防止数据空跑
   2. 释放临时表
   3. 任务名最好和表名一致
   4. 生命周期：ODS/DWD保留所有；DWS/ADS/DM设置生命周期
   5. DWD压缩：lzo
6. 应用迁移

数仓建模工具EasyDesign

![img](imgs/数据治理-网易中台课/74c84414f5e004cbc1351c6e77d1e0b5.jpg)

![img](imgs/数据治理-网易中台课/6493f76676d8d40beb8a84c2554d0a04.jpg)



![img](imgs/数据治理-网易中台课/50849628d758e95666ee5d3cce9ed7bc.jpg)



![img](imgs/数据治理-网易中台课/056037d1806f48243643a3689a89e14b.jpg)

### 07 | 同事老打脸说数据有问题，该怎么彻底解决？

数据质量问题根源：

+ 业务源系统变更
+ 数据开发BUG
+ 物理资源不足
+ 基础设施不稳定

稽核校验任务 ：完整性规则、一致性规则、准确性规则

全链路监控：有必要基于数据血缘关系，建立全链路数据质量监控。

数据质量中心（DQC）：

![img](imgs/数据治理-网易中台课/f39b371750e39eabde620ced05d0f0b1.jpg)



![img](imgs/数据治理-网易中台课/702ec67c9cb0f5b572a64af4289c31ef.jpg)

基础规则：例如IP字段格式校验、主键唯一校验、表行数波动率校验、其他自定义SQL方式。

全链路监控：（红色代表异常）

![img](imgs/数据治理-网易中台课/dd914160281cd1872eedb0717fb6c6c6.jpg)

![img](imgs/数据治理-网易中台课/33c40b8caedcd08edf50efeddbe6f26c.jpg)

### 08 | 交付速度和质量问题解决了，老板说还得“省”

八大陷进：

1. 数据上线容易下线难
2. 低价值数据消耗大资源
3. 烟囱式开发模式
4. 数据倾斜
5. 未设置生命周期
6. 调度周期不合理
7. 任务参数配置
8. 数据未压缩

![img](imgs/数据治理-网易中台课/86978c0d60e6cc050b1b9fc512221b36.png)

数据下线执行过程图：

![img](imgs/数据治理-网易中台课/9a782afd76ce95cab7e224afb97e123b.jpg)

网易成本治理中心：

![img](imgs/数据治理-网易中台课/94acdfab6f168b955d16109748abed8d.png)



![img](imgs/数据治理-网易中台课/047cef40dba74b20b9d97f31d92216f4.png)



![img](imgs/数据治理-网易中台课/c233339ec939674b3e1517d69d7b9bb7.jpg)



### 09 | 数据服务到底解决了什么问题？

数据服务痛点

1. 数据接入方式多样，接入效率低
2. 数据和接口没办法复用
3. 不知道数据被哪些应用访问
4. 数据部门字段变更导致应用变更

![img](imgs/数据治理-网易中台课/bc053d290f89c901d0916d94dbc1ec90.jpg)

### 10 | 数据服务难道就是对外提供个API吗？

数据服务八大功能：

![img](imgs/数据治理-网易中台课/d3e6a9bf2d88b050250351ac276c8029.jpg)

作者与菜鸟驿站服务对比说明：

+ 接口规范化定义，可以看成是取快递约定的收货码，基于统一的收货码取走快递；
+ 数据网关，可以看成是我们对每个货架前的队伍进行限流，确保每个队伍都能取走快递；
+ 链路关系的维护，可以看作是驿站会记录谁取走了什么快递；
+ 数据交付，可以看作驿站同时提供取快递和送货上门服务；
+ 提供多样中间存储，可以看成有不同类型的货架；
+ 逻辑模型，可以看成是一个工作人员，可以取多个货架的快递；
+ API 接口，可以看作是驿站的不同货架的不同队伍导览；
+ API 测试，可以看作是驿站工作人员上岗前的测试。

怎么做：

1. 接口规范化定义
2. 实现数据网关：具备认证、权限、限流、监控四大功能
3. 全链路打通：负责维护数据模型到数据应用的链路关系
4. 推和拉的数据交付方式
5. 利用中间存储，加速数据查询； (传统关系库/HBase/MyCat/GreenPlum/Redis)
6. 逻辑模型（视图）
7. 构建 API 集市，实现接口复用

设计原则：

+ 云原生

  ![img](imgs/数据治理-网易中台课/1844f8bf8facbba99c46a8b507203369.jpg)

+ 逻辑模型

  ![img](imgs/数据治理-网易中台课/c3a2793aa44c4da16b60f80bb2ac626d.jpg)

+ 数据自动导出



接口规范化定义

![img](imgs/数据治理-网易中台课/c65a500e6c72670c36aa96b0fb3e52e5.png)



数据网关：![img](https://static001.geekbang.org/resource/image/71/c4/71b7881dc2eba1ab3f91d6682d2ad1c4.png)

![img](imgs/数据治理-网易中台课/71b7881dc2eba1ab3f91d6682d2ad1c4.png)



![img](imgs/数据治理-网易中台课/a83b384e3fd4932f2bf4fcc4babcd86c.jpg)

### 11 | 怎么一劳永逸地解决数据安全问题？

误删？泄漏？开发生产交杂？

![img](imgs/数据治理-网易中台课/b2fc3e4ff33a32feef34f224e0f434f3.jpg)



1. 网易HDFS数据备份： HDFS 快照 + DistCp + EC

2. 垃圾回收机制：开启HDFS的垃圾站功能。（默认HDFS API DELETE会直接删除）

3. 精细化的权限管理：OpenLDAP + Kerberos + Ranger 实现一体化用户、认证、权限管理体系

4. 操作审计机制：

   ![img](imgs/数据治理-网易中台课/e60423e0a54035a06dc0885a67fc99e4.jpg)

5. 开发和生产集群物理隔离



### 12 | 数据的台子搭完了，但你还得想好戏该怎么唱

![img](imgs/数据治理-网易中台课/a3aad90b94b15e4ea4848fa8c156436d.jpg)

网易自助取数平台 EasyFetch:

![img](imgs/数据治理-网易中台课/c0161537e2ae0d5022ceeac7d0fa09f2.png)

+ 图形化替代sql
+ 统一业务口径
+ 筛选过滤、界面友好

![img](imgs/数据治理-网易中台课/cd21535b991f4266b393ed4562911998.jpg)

### 13 | 数据研发就只是写代码吗？

你不但要有技术的思维，更要有管理者的视角。三个最常见的协作流程：数据研发、数据分析、资产管理

![img](imgs/数据治理-网易中台课/135074b35571f137b6299fcf058d12fc.jpg)

+ 需求阶段： 指标需求

+ 研发阶段：模型设计

  ![img](imgs/数据治理-网易中台课/b6acb7c9ce4f37118d8dce82bcbd83f4.jpg)

  ![img](imgs/数据治理-网易中台课/2dde6ba76dca0bcdb066293c0a279978.jpg)

  

+ 交付阶段：数据抽取到中间存储，提供API接口

+ 运维阶段：任务报警责任人

  ![img](imgs/数据治理-网易中台课/b5dded288ffee1c3b09fdd6b566efda9.jpg)

### 14 | 数据被加工后，你还要学会使用和管理数据

1. 发现业务问题
2. 理解数据
3. 探索式分析
4. 可视化展现
5. 分析过程产品化（复盘）

![img](imgs/数据治理-网易中台课/cb9eb41313f04fe00a15a6adf10f86b2.jpg)

### 15 | 数据中台在网易电商业务的最佳实践

+ 第一步，调整团队组织架构，明确各个团队的职责。数据中台主要负责 DW 层公共数据，以及跨部门共享的集市层和应用层的数据建设。
+ 第二步，数据整合。**中台团队必须要完全接管 ODS 层数据**。
+ 第三步，研发工具产品。网易数据中台支撑技术工具产品架构图：

![img](imgs/数据治理-网易中台课/a0604418589bb759adf3dd89000ef9d7.jpg)



![img](imgs/数据治理-网易中台课/314391dc67b377bdyy1c83036fbb7e1d.jpg)

+ 第四，数据产品构建。



![img](imgs/数据治理-网易中台课/cf934a2f72617bdeed632ca0e77ffd07.jpg)





## 第三代架构与端到端数据流网易数帆

![image-20220308095720238](imgs/数据治理-网易中台课/image-20220308095720238.png)

![img](imgs/数据治理-网易中台课/202103291959287d1cf180-5b4d-464b-9d5d-b190059ec373.png)



元数据管理工具的能力 https://cloud.tencent.com/developer/article/1165663

![image-20220308134847044](imgs/数据治理-网易中台课/image-20220308134847044.png)





前端管理提交和管理实时计算任务

| field    | value   |      |
| -------- | ------- | ---- |
| 名称     |         |      |
| 任务状态 |         |      |
| 运行状态 |         |      |
| 标签     |         |      |
| 启动时间 |         |      |
| 集群     |         |      |
| 类型     | SQL/jar |      |
| 创建人   | yww     |      |
| 资源用量 | 2核 5G  |      |



## LinkedIn Datahub [架构解析](https://engineering.linkedin.com/blog/2020/datahub-popular-metadata-architectures-explained)

### 第一代结构

- **搜索和发现：**数据模式、字段、标签、使用信息
- **访问控制：**访问控制组、用户、策略
- **数据血统：**管道执行、查询、API 日志、API 模式
- **合规性：**数据隐私/合规注释类型的分类
- **数据管理：**数据源配置、摄取配置、保留配置、数据清除策略（例如，对于 GDPR“被遗忘权”）、数据导出策略（例如，对于 GDPR“访问权”）
- **AI 可解释性、可再现性：**特征定义、模型定义、训练运行执行、问题陈述
- **数据操作：**管道执行、处理的数据分区、数据统计
- **数据质量：**数据质量规则定义、规则执行结果、数据统计

![显示基于拉的 etl 的第一代架构的图表](imgs/数据治理-网易中台课/metadata-1.png)

采用拉取的模式： 问题障碍：网络连接（防火墙规则）或凭证共享；元数据新鲜度，非增量

### 第二代架构：带Service-Api的三层架构



![图表显示第二代服务架构与推送 API](imgs/数据治理-网易中台课/metadata-2.png)

优点：更好的合约带来更好的结果；启用编程用例

缺陷：没有更改日志；依赖中心化团队



### 第三代架构：事件源元数据

![显示未捆绑元数据数据库的第三代架构的图表](imgs/数据治理-网易中台课/metadata-3.png)



第三代架构与端到端数据流

![图表显示第三代架构与端到端数据流](imgs/数据治理-网易中台课/metadata-5.png)



三代架构中的各个产品：

![不同元数据架构的快照](imgs/数据治理-网易中台课/metadata-6.png)



## 数据湖Again

数据湖是一种架构，通常是围绕对象存储未“湖底座”的大数据管理方案组合。例如，AWS中数据湖是由一系列数据管理工具组成：

![image-20220308162058020](imgs/数据治理-网易中台课/image-20220308162058020.png)



**A**mazon **W**eb **S**ervices官方给出了**智能湖仓**的参考架构

![640-95](imgs/数据治理-网易中台课/640-95.png)